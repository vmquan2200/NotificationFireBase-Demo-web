<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>FCM Foreground + Background Split</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:720px;margin:24px auto;padding:0 12px}
    button{padding:10px 14px;margin:6px 6px 6px 0;border-radius:10px;border:1px solid #ddd;cursor:pointer}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;margin-left:8px}
    /* Toast: góc trên bên phải, to và nổi bật */
    #toast{
      position:fixed;
      top:20px;
      right:20px;
      max-width:360px;
      background:#111;
      color:#fff;
      font-size:20px;
      font-weight:bold;
      padding:20px 24px;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s, transform .25s;
      transform:translateY(-20px);
    }
    #toast.show{ opacity:1; transform:translateY(0); }
    pre{background:#f6f7f9;padding:10px;border-radius:8px;min-height:120px;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>FCM: Foreground vs Background</h1>

  <div>
    <button id="btn-init">Get Token</button>
    <button id="btn-toggle">Start</button>
    <span id="status" class="pill">OFF</span>
  </div>

  <!-- Khung nhập nội dung thông báo -->
  <div style="margin-top:16px">
    <input id="msgTitle" placeholder="Nhập tiêu đề thông báo" style="padding:8px;width:250px"/>
    <input id="msgBody"  placeholder="Nhập nội dung thông báo" style="padding:8px;width:350px"/>
    <button id="btn-update">Update message</button>
  </div>

  <pre id="log"></pre>
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-messaging.js";

    // ⚠️ Thay bằng config dự án của bạn nếu cần
    const firebaseConfig = {
      apiKey: "AIzaSyC_wYfigjo52Yi6K3oWk7_BmKz9JynTUR0",
      authDomain: "notification-537d7.firebaseapp.com",
      projectId: "notification-537d7",
      storageBucket: "notification-537d7.firebasestorage.app",
      messagingSenderId: "779369159825",
      appId: "1:779369159825:web:1f05b553ab071c20797330",
      measurementId: "G-PVM55NDDBX"
    };
    const VAPID_PUBLIC_KEY = "BJkDvXoJgIHg8RX9Pl8Scddax8ZyimYYABACVX2VqFTT7vgBDRXM5PiqN0Swro2Y5Tlm2S20LndwhVXtfXkC1ao";

    const app = initializeApp(firebaseConfig);
    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const toggleBtn = document.getElementById("btn-toggle");
    const toastEl = document.getElementById("toast");
    let TOKEN = "";

    const log = (m) => { logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
    const toast = (t) => { toastEl.textContent = t; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), 2500); };

    async function api(path, body) {
      const res = await fetch(path, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body || {}) });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { raw: text }; }
    }

    async function refreshStatus() {
      const r = await api("/status");
      const on = !!r?.enabled;
      statusEl.textContent = on ? "ON" : "OFF";
      toggleBtn.textContent = on ? "Stop" : "Start";
      log("status: " + JSON.stringify(r));
    }

    async function getTheToken() {
      if (!(await isSupported())) { log("❌ FCM not supported."); return; }
      const perm = await Notification.requestPermission();
      if (perm !== "granted") { alert("Bạn cần Allow notifications."); return; }
      const reg = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
      const messaging = getMessaging(app);
      TOKEN = await getToken(messaging, { vapidKey: VAPID_PUBLIC_KEY, serviceWorkerRegistration: reg });
      log("Token: " + (TOKEN ? TOKEN : "null"));

      // FOREGROUND: hiện trong trang (tránh dùng Notification API để không trùng background)
      onMessage(messaging, (payload) => {
        const title = payload?.data?.title || "Foreground Ping";
        const body  = payload?.data?.body  || JSON.stringify(payload?.data || {});
        log("Foreground data: " + body);
        toast(`${title}: ${body}`);
      });
    }

    async function toggle() {
      if (!TOKEN) { alert("Nhấn Get Token trước."); return; }
      const isOn = statusEl.textContent === "ON";
      const r = await api(isOn ? "/disable" : "/enable", { token: TOKEN });
      log("toggle: " + JSON.stringify(r));
      await refreshStatus();
    }

    async function updateMessage() {
      const title = document.getElementById("msgTitle").value || "⏰ Ping 30s";
      const body  = document.getElementById("msgBody").value  || "Nội dung mặc định";
      const r = await api("/setMessage", { title, body });
      log("updateMessage: " + JSON.stringify(r));
    }

    document.getElementById("btn-init").onclick   = getTheToken;
    document.getElementById("btn-toggle").onclick = toggle;
    document.getElementById("btn-update").onclick = updateMessage;

    refreshStatus();
  </script>
</body>
</html>
