<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>FCM Simple Demo</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:720px;margin:24px auto;padding:0 12px}
    button{padding:10px 14px;margin:6px 6px 6px 0;border-radius:10px;border:1px solid #ddd;cursor:pointer}
    pre{background:#f6f7f9;padding:10px;border-radius:8px;min-height:120px;white-space:pre-wrap}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;margin-left:8px}
  </style>
</head>
<body>
  <h1>FCM 1-Min Toggle (Simple)</h1>

  <div>
    <button id="btn-init">Get Token</button>
    <button id="btn-toggle">Start</button>
    <span id="status" class="pill">OFF</span>
  </div>

  <pre id="log"></pre>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-messaging.js";

    // ⚠️ Firebase config của bạn (đang dùng demo; thay bằng config dự án của bạn nếu cần)
    const firebaseConfig = {
      apiKey: "AIzaSyC_wYfigjo52Yi6K3oWk7_BmKz9JynTUR0",
      authDomain: "notification-537d7.firebaseapp.com",
      projectId: "notification-537d7",
      storageBucket: "notification-537d7.firebasestorage.app",
      messagingSenderId: "779369159825",
      appId: "1:779369159825:web:1f05b553ab071c20797330",
      measurementId: "G-PVM55NDDBX"
    };
    const VAPID_PUBLIC_KEY = "BMQWLtQTJfnp00nGFflMg6Cqg2onQIoqfiBQUy8xMKNcT6Qqhtd9HekfPwvLCU-LpIJFN236ma8ZI_QWLYVoGpQ";

    const app = initializeApp(firebaseConfig);
    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const toggleBtn = document.getElementById("btn-toggle");
    let TOKEN = "";

    const log = (m) => { logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };

    async function api(path, body) {
      const res = await fetch(path, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(body || {}) });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { raw: text }; }
    }

    async function refreshStatus() {
      const r = await api("/status");
      const on = !!r?.enabled;
      statusEl.textContent = on ? "ON" : "OFF";
      toggleBtn.textContent = on ? "Stop" : "Start";
      log("status: " + JSON.stringify(r));
    }

    async function getTheToken() {
      if (!(await isSupported())) { log("❌ FCM not supported."); return; }
      const perm = await Notification.requestPermission();
      if (perm !== "granted") { alert("Bạn cần Allow notifications."); return; }
      const reg = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
      const messaging = getMessaging(app);
      TOKEN = await getToken(messaging, { vapidKey: VAPID_PUBLIC_KEY, serviceWorkerRegistration: reg });
      log("Token: " + (TOKEN ? TOKEN : "null"));
      onMessage(messaging, (payload) => {
        log("Foreground: " + JSON.stringify(payload));
        if (payload?.notification?.title) new Notification(payload.notification.title, { body: payload.notification.body });
      });
    }

    async function toggle() {
      if (!TOKEN) { alert("Nhấn Get Token trước."); return; }
      const isOn = statusEl.textContent === "ON";
      const r = await api(isOn ? "/disable" : "/enable", { token: TOKEN });
      log("toggle: " + JSON.stringify(r));
      await refreshStatus();
    }

    document.getElementById("btn-init").onclick = getTheToken;
    document.getElementById("btn-toggle").onclick = toggle;

    refreshStatus();
  </script>
</body>
</html>
